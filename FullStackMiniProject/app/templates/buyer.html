<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Buyer Dashboard - BidHub</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link rel="stylesheet" href="../static/styles.css"/>
</head>
<body>
  <nav>
    <a href="/" class="logo">
      <i class="fas fa-gavel"></i> BidHub
    </a>
    <div class="nav-links">
      <a href="ulr_for('buyer',user_id=user_id)">
        <i class="fas fa-shopping-cart"></i> Buyer
      </a>
      <a href="ulr_for('seller',user_id=user_id)">
        <i class="fas fa-plus-circle"></i> Seller
      </a>
      <a href="ulr_for('profile',user_id=user_id)">
        <i class="fas fa-user"></i> Profile
      </a>
    </div>
    <div class="user-info">
      <div class="notification-icon" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge">3</span>
      </div>
      <span>Welcome, {{ name }}!</span>
      <a href="/" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>
  </nav>

  <div class="main-content">
    <div class="page-header">
      <h1><i class="fas fa-shopping-cart"></i> Current Auctions</h1>
      <p>Discover amazing deals and place your bids on the latest items. Items are sorted from newest to oldest.</p>
    </div>

    <!-- === PRODUCT DISPLAY SECTION === -->
    <div class="products-grid">
      {% for product in products %}
        <div class="product-card">
          <div class="product-image">
            <img src="data:image/png;base64,{{ product.image_base64 }}">
          </div>
          <div class="product-info">
            <h3 class="product-title">{{ product.title }}</h3>
            <p class="product-description">
              {{ product.description }}
            </p>
            <div class="product-meta">
              <span class="current-bid">{{ product.price }}</span>
              <span class="time-left">{{ product.duration }}</span>
            </div>
            <button class="bid-button" onclick="openBidModal('{{ product.product_id }}', '{{ product.title }}', '{{ product.price }}')">
              <i class="fas fa-gavel"></i> Place Bid
            </button>
          </div>
        </div>
      {% endfor %}
      <!-- Sample Product 1 -->
      <div class="product-card">
        <div class="product-image">
          <i class="fas fa-laptop" style="font-size: 3em; color: var(--primary-color);"></i>
        </div>
        <div class="product-info">
          <h3 class="product-title">MacBook Pro 2023 - Like New</h3>
          <p class="product-description">
            13-inch MacBook Pro with M2 chip, 8GB RAM, 256GB SSD. Excellent condition, barely used.
          </p>
          <div class="product-meta">
            <span class="current-bid">$1,250.00</span>
            <span class="time-left">2h 15m left</span>
          </div>
          <button class="bid-button" onclick="openBidModal('PRD001', 'MacBook Pro 2023 - Like New', 1250.00)">
            <i class="fas fa-gavel"></i> Place Bid
          </button>
        </div>
      </div>

      <!-- Sample Product 2 -->
      <div class="product-card">
        <div class="product-image">
          <i class="fas fa-camera" style="font-size: 3em; color: var(--accent-color);"></i>
        </div>
        <div class="product-info">
          <h3 class="product-title">Canon EOS R5 Professional Camera</h3>
          <p class="product-description">
            Professional mirrorless camera with 45MP sensor. Includes original box and accessories.
          </p>
          <div class="product-meta">
            <span class="current-bid">$2,800.00</span>
            <span class="time-left">5h 42m left</span>
          </div>
          <button class="bid-button" onclick="openBidModal('PRD002', 'Canon EOS R5 Professional Camera', 2800.00)">
            <i class="fas fa-gavel"></i> Place Bid
          </button>
        </div>
      </div>

      <!-- Sample Product 3 -->
      <div class="product-card">
        <div class="product-image">
          <i class="fas fa-gem" style="font-size: 3em; color: var(--success-color);"></i>
        </div>
        <div class="product-info">
          <h3 class="product-title">Vintage Diamond Ring</h3>
          <p class="product-description">
            Beautiful vintage diamond engagement ring, 1.5 carat, certified authentic with appraisal.
          </p>
          <div class="product-meta">
            <span class="current-bid">$3,500.00</span>
            <span class="time-left">1d 3h left</span>
          </div>
          <button class="bid-button" onclick="openBidModal('PRD003', 'Vintage Diamond Ring', 3500.00)">
            <i class="fas fa-gavel"></i> Place Bid
          </button>
        </div>
      </div>

      <!-- Sample Product 4 -->
      <div class="product-card">
        <div class="product-image">
          <i class="fas fa-gamepad" style="font-size: 3em; color: var(--warning-color);"></i>
        </div>
        <div class="product-info">
          <h3 class="product-title">PlayStation 5 Console Bundle</h3>
          <p class="product-description">
            Brand new PS5 console with extra controller and 3 popular games included.
          </p>
          <div class="product-meta">
            <span class="current-bid">$650.00</span>
            <span class="time-left">3d 12h left</span>
          </div>
          <button class="bid-button" onclick="openBidModal('PRD004', 'PlayStation 5 Console Bundle', 650.00)">
            <i class="fas fa-gavel"></i> Place Bid
          </button>
        </div>
      </div>

      <!-- Sample Product 5 -->
      <div class="product-card">
        <div class="product-image">
          <i class="fas fa-paint-brush" style="font-size: 3em; color: var(--accent-color);"></i>
        </div>
        <div class="product-info">
          <h3 class="product-title">Original Oil Painting - Landscape</h3>
          <p class="product-description">
            Beautiful original landscape painting by local artist. Framed and ready to hang.
          </p>
          <div class="product-meta">
            <span class="current-bid">$425.00</span>
            <span class="time-left">6d 8h left</span>
          </div>
          <button class="bid-button" onclick="openBidModal('PRD005', 'Original Oil Painting - Landscape', 425.00)">
            <i class="fas fa-gavel"></i> Place Bid
          </button>
        </div>
      </div>

      <!-- Sample Product 6 -->
      <div class="product-card">
        <div class="product-image">
          <i class="fas fa-bicycle" style="font-size: 3em; color: var(--primary-color);"></i>
        </div>
        <div class="product-info">
          <h3 class="product-title">Mountain Bike - Trek 2022</h3>
          <p class="product-description">
            High-performance mountain bike, lightly used. Perfect for trails and outdoor adventures.
          </p>
          <div class="product-meta">
            <span class="current-bid">$890.00</span>
            <span class="time-left">1w 2d left</span>
          </div>
          <button class="bid-button" onclick="openBidModal('PRD006', 'Mountain Bike - Trek 2022', 890.00)">
            <i class="fas fa-gavel"></i> Place Bid
          </button>
        </div>
      </div>
    </div>
    <!-- === END PRODUCT DISPLAY SECTION === -->

  </div>

  <!-- Bid Modal -->
  <div id="bidModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-gavel"></i> Place Your Bid</h2>
        <button class="close-modal" onclick="closeBidModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="bid-product-info">
          <h3 id="bidProductName">Product Name</h3>
          <div class="current-high-bid">
            <span>Current Highest Bid:</span>
            <strong id="currentBidAmount">$0.00</strong>
          </div>
        </div>

        <div class="bids-history">
          <h4><i class="fas fa-history"></i> Bid History</h4>
          <div class="bids-list" id="bidsList">
            <!-- Bid history will be populated here -->
          </div>
        </div>

        <div class="bid-form">
          <div class="form-group">
            <label for="bidAmount">Your Bid Amount ($)</label>
            <input 
              type="number" 
              id="bidAmount" 
              step="0.01" 
              min="0" 
              placeholder="Enter your bid amount"
            >
            <div class="bid-help">
              <small>Minimum bid: $<span id="minBid">0.00</span></small>
              <small>Bid increments: $5.00</small>
            </div>
          </div>
          
          <div class="bid-summary">
            <div class="summary-item">
              <span>Your Bid:</span>
              <span id="summaryBid">$0.00</span>
            </div>
            <div class="summary-item">
              <span>Service Fee (5%):</span>
              <span id="summaryFee">$0.00</span>
            </div>
            <div class="summary-item total">
              <span>Total:</span>
              <span id="summaryTotal">$0.00</span>
            </div>
          </div>

          <div class="bid-terms">
            <label class="checkbox-option">
              <input type="checkbox" id="agreeTerms">
              <span>I agree to the <a href="#">Bidding Terms</a> and understand this is a binding offer</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeBidModal()">Cancel</button>
        <button class="btn-confirm" id="confirmBidBtn" onclick="placeBid()">Place Bid</button>
      </div>
    </div>
  </div>

  <style>
    /* Bid Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 25px 30px 15px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.4em;
      color: var(--text-color);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.3em;
      cursor: pointer;
      color: var(--text-light);
      padding: 5px;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-modal:hover {
      background: #f5f5f5;
    }

    .modal-body {
      padding: 25px 30px;
    }

    .bid-product-info {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #f0f0f0;
    }

    .bid-product-info h3 {
      margin: 0 0 15px 0;
      font-size: 1.2em;
      color: var(--text-color);
    }

    .current-high-bid {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-color);
      padding: 15px;
      border-radius: 8px;
    }

    .current-high-bid span {
      color: var(--text-light);
      font-weight: 600;
    }

    .current-high-bid strong {
      font-size: 1.3em;
      color: var(--success-color);
    }

    .bids-history {
      margin-bottom: 25px;
    }

    .bids-history h4 {
      margin: 0 0 15px 0;
      font-size: 1.1em;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bids-list {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      padding: 10px;
    }

    .bid-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f9f9f9;
    }

    .bid-item:last-child {
      border-bottom: none;
    }

    .bidder-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bidder-avatar {
      width: 30px;
      height: 30px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8em;
    }

    .bidder-name {
      font-weight: 600;
      color: var(--text-color);
    }

    .bid-amount {
      font-weight: 700;
      color: var(--success-color);
    }

    .bid-time {
      font-size: 0.8em;
      color: var(--text-light);
    }

    .bid-form .form-group {
      margin-bottom: 20px;
    }

    .bid-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
    }

    .bid-form input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 600;
    }

    .bid-form input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .bid-help {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }

    .bid-help small {
      color: var(--text-light);
      font-size: 0.85em;
    }

    .bid-summary {
      background: var(--bg-color);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .summary-item:last-child {
      margin-bottom: 0;
    }

    .summary-item.total {
      border-top: 1px solid #ddd;
      padding-top: 10px;
      font-weight: 700;
      font-size: 1.1em;
      color: var(--text-color);
    }

    .bid-terms {
      margin-bottom: 20px;
    }

    .checkbox-option {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      cursor: pointer;
      font-size: 0.9em;
      color: var(--text-light);
    }

    .checkbox-option input[type="checkbox"] {
      margin-top: 2px;
    }

    .checkbox-option a {
      color: var(--primary-color);
      text-decoration: none;
    }

    .checkbox-option a:hover {
      text-decoration: underline;
    }

    .modal-footer {
      padding: 20px 30px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      gap: 15px;
    }

    .btn-cancel, .btn-confirm {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-cancel {
      background: var(--text-light);
      color: white;
    }

    .btn-cancel:hover {
      background: #5c6e7a;
    }

    .btn-confirm {
      background: var(--primary-color);
      color: white;
    }

    .btn-confirm:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-confirm:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Empty state for bids */
    .no-bids {
      text-align: center;
      padding: 20px;
      color: var(--text-light);
      font-style: italic;
    }

    /* Your bid highlight */
    .your-bid {
      background: rgba(19, 137, 255, 0.1);
      border-radius: 4px;
      padding: 5px 8px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .modal {
        padding: 10px;
      }

      .modal-content {
        max-height: 95vh;
      }

      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 20px;
      }

      .current-high-bid {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .bid-help {
        flex-direction: column;
        gap: 5px;
      }
    }
  </style>

  <script>
    let currentProductId = null;
    let currentHighestBid = 0;

    // Mock bid data for demonstration
    const mockBidData = {
      'PRD001': [
        { bidder: 'You', amount: 1200.00, time: '2 minutes ago', isCurrentUser: true },
        { bidder: 'Bidder123', amount: 1250.00, time: '5 minutes ago', isCurrentUser: false },
        { bidder: 'TechLover', amount: 1150.00, time: '15 minutes ago', isCurrentUser: false },
        { bidder: 'AppleFan', amount: 1100.00, time: '1 hour ago', isCurrentUser: false }
      ],
      'PRD002': [
        { bidder: 'PhotoPro', amount: 2800.00, time: '10 minutes ago', isCurrentUser: false },
        { bidder: 'You', amount: 2750.00, time: '25 minutes ago', isCurrentUser: true },
        { bidder: 'CameraGuy', amount: 2700.00, time: '45 minutes ago', isCurrentUser: false }
      ],
      'PRD003': [
        { bidder: 'JewelCollector', amount: 3500.00, time: '2 hours ago', isCurrentUser: false },
        { bidder: 'DiamondLover', amount: 3400.00, time: '3 hours ago', isCurrentUser: false }
      ],
      'PRD004': [
        { bidder: 'GamerPro', amount: 650.00, time: '1 day ago', isCurrentUser: false },
        { bidder: 'You', amount: 625.00, time: '1 day ago', isCurrentUser: true }
      ],
      'PRD005': [
        { bidder: 'ArtLover', amount: 425.00, time: '2 days ago', isCurrentUser: false }
      ],
      'PRD006': [
        { bidder: 'AdventureSeeker', amount: 890.00, time: '3 days ago', isCurrentUser: false },
        { bidder: 'You', amount: 875.00, time: '4 days ago', isCurrentUser: true }
      ]
    };

    function openBidModal(productId, productName, currentBid) {
      currentProductId = productId;
      currentHighestBid = currentBid;
      
      // Update modal content
      document.getElementById('bidProductName').textContent = productName;
      document.getElementById('currentBidAmount').textContent = `$${currentBid.toFixed(2)}`;
      document.getElementById('minBid').textContent = (currentBid + 5).toFixed(2);
      document.getElementById('bidAmount').value = (currentBid + 5).toFixed(2);
      document.getElementById('bidAmount').min = (currentBid + 5).toFixed(2);
      
      // Update bid history
      updateBidHistory(productId);
      
      // Update summary
      updateBidSummary();
      
      // Reset terms checkbox
      document.getElementById('agreeTerms').checked = false;
      
      // Show modal
      document.getElementById('bidModal').classList.remove('hidden');
    }

    function closeBidModal() {
      document.getElementById('bidModal').classList.add('hidden');
      currentProductId = null;
    }

    function updateBidHistory(productId) {
      const bidsList = document.getElementById('bidsList');
      const bids = mockBidData[productId] || [];
      
      if (bids.length === 0) {
        bidsList.innerHTML = '<div class="no-bids">No bids yet. Be the first to bid!</div>';
        return;
      }
      
      bidsList.innerHTML = bids.map(bid => `
        <div class="bid-item ${bid.isCurrentUser ? 'your-bid' : ''}">
          <div class="bidder-info">
            <div class="bidder-avatar">
              <i class="fas fa-user"></i>
            </div>
            <div>
              <div class="bidder-name">${bid.bidder}</div>
              <div class="bid-time">${bid.time}</div>
            </div>
          </div>
          <div class="bid-amount">$${bid.amount.toFixed(2)}</div>
        </div>
      `).join('');
    }

    function updateBidSummary() {
      const bidAmount = parseFloat(document.getElementById('bidAmount').value) || 0;
      const serviceFee = bidAmount * 0.05;
      const total = bidAmount + serviceFee;
      
      document.getElementById('summaryBid').textContent = `$${bidAmount.toFixed(2)}`;
      document.getElementById('summaryFee').textContent = `$${serviceFee.toFixed(2)}`;
      document.getElementById('summaryTotal').textContent = `$${total.toFixed(2)}`;
      
      // Enable/disable confirm button based on bid amount
      const minBid = currentHighestBid + 5;
      const confirmBtn = document.getElementById('confirmBidBtn');
      const agreedToTerms = document.getElementById('agreeTerms').checked;
      
      confirmBtn.disabled = bidAmount < minBid || !agreedToTerms;
    }

    function placeBid() {
      const bidAmount = parseFloat(document.getElementById('bidAmount').value);
      const minBid = currentHighestBid + 5;
      
      if (bidAmount < minBid) {
        alert(`Your bid must be at least $${minBid.toFixed(2)} to outbid the current highest bid.`);
        return;
      }
      
      if (!document.getElementById('agreeTerms').checked) {
        alert('Please agree to the bidding terms before placing your bid.');
        return;
      }
      
      // In a real application, this would send the bid to the server
      // For demo purposes, we'll just show a success message
      alert(`Success! Your bid of $${bidAmount.toFixed(2)} has been placed for "${document.getElementById('bidProductName').textContent}".`);
      
      // Update the current bid display on the product card
      const productCard = document.querySelector(`.bid-button[onclick*="${currentProductId}"]`).closest('.product-card');
      const currentBidSpan = productCard.querySelector('.current-bid');
      currentBidSpan.textContent = `$${bidAmount.toFixed(2)}`;
      
      // Update the highest bid in the modal
      currentHighestBid = bidAmount;
      document.getElementById('currentBidAmount').textContent = `$${bidAmount.toFixed(2)}`;
      document.getElementById('minBid').textContent = (bidAmount + 5).toFixed(2);
      
      // Add the new bid to the history
      if (!mockBidData[currentProductId]) {
        mockBidData[currentProductId] = [];
      }
      
      mockBidData[currentProductId].unshift({
        bidder: 'You',
        amount: bidAmount,
        time: 'Just now',
        isCurrentUser: true
      });
      
      updateBidHistory(currentProductId);
      closeBidModal();
    }

    // Event listeners for real-time updates
    document.addEventListener('DOMContentLoaded', function() {
      
      // Close modal when clicking outside
      document.getElementById('bidModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeBidModal();
        }
      });
    });
  </script>
</body>
</html>